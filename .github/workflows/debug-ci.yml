name: Debug CI Issues

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to debug (all, postgres, keycloak, backend, frontend)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - postgres
          - keycloak
          - backend
          - frontend

env:
  MINIKUBE_VERSION: v1.32.0
  KUBERNETES_VERSION: v1.28.0

jobs:
  debug:
    name: Debug Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Start Minikube
      run: |
        curl -LO https://storage.googleapis.com/minikube/releases/${{ env.MINIKUBE_VERSION }}/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
        minikube start --cpus=2 --memory=6144 --disk-size=20g --driver=docker --kubernetes-version=${{ env.KUBERNETES_VERSION }}
        minikube status
        minikube addons enable ingress
        minikube addons enable metrics-server

    - name: Wait for Metrics Server
      run: |
        echo "Waiting for metrics-server to be ready..."
        kubectl wait --for=condition=ready pod -l k8s-app=metrics-server -n kube-system --timeout=120s

    - name: Show Cluster Info
      run: |
        echo "Cluster Info:"
        kubectl cluster-info
        echo ""
        echo "Node Info:"
        kubectl get nodes -o wide
        echo ""
        echo "Node Resources:"
        kubectl describe nodes
        echo ""
        echo "Available Resources:"
        kubectl top nodes

    - name: Make scripts executable
      run: chmod +x scripts/*.sh

    - name: Run Setup Script
      run: |
        ./scripts/setup-minikube.sh
        ./scripts/preflight-check.sh

    - name: Deploy PostgreSQL Only
      if: inputs.component == 'all' || inputs.component == 'postgres'
      run: |
        echo "Deploying PostgreSQL..."
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/postgres/

        echo "Waiting for PostgreSQL..."
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=postgres -n auth-platform --timeout=300s

        echo "PostgreSQL Status:"
        kubectl get pods -n auth-platform -l app.kubernetes.io/name=postgres -o wide
        kubectl logs -n auth-platform -l app.kubernetes.io/name=postgres --tail=50

        echo "Testing PostgreSQL connectivity:"
        POSTGRES_POD=$(kubectl get pods -n auth-platform -l app.kubernetes.io/name=postgres -o jsonpath='{.items[0].metadata.name}')
        kubectl exec -n auth-platform $POSTGRES_POD -- pg_isready -U keycloak

    - name: Deploy Keycloak Only
      if: inputs.component == 'all' || inputs.component == 'keycloak'
      run: |
        echo "Deploying Keycloak..."
        kubectl apply -f k8s/keycloak/

        echo "Monitoring Keycloak startup..."

        # Monitor for 10 minutes
        for i in {1..40}; do
          echo "Check $i/40 ($(($i * 15))s elapsed)"

          kubectl get pods -n auth-platform -l app.kubernetes.io/name=keycloak -o wide

          POD_STATUS=$(kubectl get pods -n auth-platform -l app.kubernetes.io/name=keycloak -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "NotFound")
          READY=$(kubectl get pods -n auth-platform -l app.kubernetes.io/name=keycloak -o jsonpath='{.items[0].status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "False")

          echo "Pod Status: $POD_STATUS, Ready: $READY"

          if [ "$READY" == "True" ]; then
            echo "âœ… Keycloak is ready!"
            break
          fi

          if [ "$POD_STATUS" == "Running" ]; then
            echo "Recent logs:"
            kubectl logs -n auth-platform -l app.kubernetes.io/name=keycloak --tail=20 || true
          fi

          if [ $i -lt 40 ]; then
            sleep 15
          fi
        done

        echo "Final Keycloak Status:"
        kubectl get pods -n auth-platform -l app.kubernetes.io/name=keycloak -o wide
        kubectl describe pod -n auth-platform -l app.kubernetes.io/name=keycloak
        kubectl logs -n auth-platform -l app.kubernetes.io/name=keycloak --tail=200

        # Check if it's actually ready
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=keycloak -n auth-platform --timeout=60s

    - name: Deploy Backend and Frontend
      if: inputs.component == 'all'
      run: |
        eval $(minikube docker-env)

        echo "Building images..."
        cd frontend && docker build -t auth-platform/angular-frontend:latest . && cd ..
        cd backend && docker build -t auth-platform/spring-backend:latest . && cd ..

        echo "Deploying backend..."
        kubectl apply -f k8s/backend/

        echo "Deploying frontend..."
        kubectl apply -f k8s/frontend/

        echo "Waiting for deployments..."
        kubectl wait --for=condition=available deployment backend -n auth-platform --timeout=300s
        kubectl wait --for=condition=available deployment frontend -n auth-platform --timeout=300s

    - name: Full Status Report
      if: always()
      run: |
        echo "========================================"
        echo "FULL CLUSTER STATUS"
        echo "========================================"
        echo ""

        echo "Namespaces:"
        kubectl get namespaces
        echo ""

        echo "Nodes:"
        kubectl get nodes -o wide
        echo ""

        echo "Node Resources:"
        kubectl top nodes || echo "Metrics not available"
        echo ""

        echo "All Pods:"
        kubectl get pods --all-namespaces -o wide
        echo ""

        echo "Auth Platform Pods:"
        kubectl get pods -n auth-platform -o wide || true
        echo ""

        echo "Pod Resources:"
        kubectl top pods -n auth-platform || echo "Metrics not available"
        echo ""

        echo "Deployments:"
        kubectl get deployments -n auth-platform || true
        echo ""

        echo "Services:"
        kubectl get services -n auth-platform || true
        echo ""

        echo "Ingress:"
        kubectl get ingress -n auth-platform || true
        echo ""

        echo "Events (last 100):"
        kubectl get events -n auth-platform --sort-by='.lastTimestamp' | tail -100 || true
        echo ""

        echo "PostgreSQL Logs:"
        kubectl logs -n auth-platform -l app.kubernetes.io/name=postgres --tail=100 || true
        echo ""

        echo "Keycloak Logs:"
        kubectl logs -n auth-platform -l app.kubernetes.io/name=keycloak --tail=200 || true
        echo ""

        echo "Backend Logs:"
        kubectl logs -n auth-platform -l app.kubernetes.io/name=backend --tail=100 || true
        echo ""

        echo "Frontend Logs:"
        kubectl logs -n auth-platform -l app.kubernetes.io/name=frontend --tail=100 || true

    - name: Cleanup
      if: always()
      run: |
        kubectl delete namespace auth-platform --ignore-not-found=true || true
        minikube delete || true
